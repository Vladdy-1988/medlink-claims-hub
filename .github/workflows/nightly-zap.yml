name: Nightly Security Scanning

on:
  schedule:
    # Run at 04:00 UTC daily
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to scan'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - development

env:
  TARGET_URL: ${{ github.event.inputs.environment == 'development' && secrets.DEV_BASE_URL || secrets.STAGING_BASE_URL }}

jobs:
  zap-scan:
    name: OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create reports directory
        run: mkdir -p zap-reports
        
      - name: Run OWASP ZAP Baseline Scan
        id: zap-scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false
          fail_action: false
          
      - name: Process ZAP Results
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ env.TARGET_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse ZAP results if available
          if [ -f zap_report.html ]; then
            # Copy report to artifacts directory
            cp zap_report.html zap-reports/
            
            # Extract vulnerability counts from the report
            HIGH_COUNT=$(grep -c "High" zap_report.html || echo "0")
            CRITICAL_COUNT=$(grep -c "Critical" zap_report.html || echo "0")
            MEDIUM_COUNT=$(grep -c "Medium" zap_report.html || echo "0")
            LOW_COUNT=$(grep -c "Low" zap_report.html || echo "0")
            
            echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count | Action Required |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|-----------------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $CRITICAL_COUNT | $([ $CRITICAL_COUNT -gt 0 ] && echo 'ðŸš¨ Immediate' || echo 'âœ… None') |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $HIGH_COUNT | $([ $HIGH_COUNT -gt 0 ] && echo 'âš ï¸ Urgent' || echo 'âœ… None') |" >> $GITHUB_STEP_SUMMARY
            echo "| Medium | $MEDIUM_COUNT | Review |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $LOW_COUNT | Monitor |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Set failure flag if critical/high vulnerabilities found
            if [ $CRITICAL_COUNT -gt 0 ] || [ $HIGH_COUNT -gt 0 ]; then
              echo "CRITICAL_VULNS_FOUND=true" >> $GITHUB_ENV
              echo "VULN_COUNT=$((CRITICAL_COUNT + HIGH_COUNT))" >> $GITHUB_ENV
              echo "CRITICAL_COUNT=$CRITICAL_COUNT" >> $GITHUB_ENV
              echo "HIGH_COUNT=$HIGH_COUNT" >> $GITHUB_ENV
            fi
            
            echo "ðŸ“„ Full report available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No ZAP report generated" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Save ZAP scan rules configuration
        run: |
          mkdir -p .zap
          cat > .zap/rules.tsv << 'EOF'
          # OWASP ZAP Baseline Scan Rules Configuration
          # Format: Rule ID [tab] PASS/FAIL/WARN/IGNORE
          10003	WARN	# Vulnerable JS Library
          10010	FAIL	# Cookie No HttpOnly Flag
          10011	WARN	# Cookie Without Secure Flag
          10015	WARN	# Incomplete or No Cache-control and Pragma HTTP Header Set
          10016	WARN	# Web Browser XSS Protection Not Enabled
          10017	WARN	# Cross-Domain JavaScript Source File Inclusion
          10019	WARN	# Content-Type Header Missing
          10020	FAIL	# X-Frame-Options Header Not Set
          10021	FAIL	# X-Content-Type-Options Header Missing
          10023	WARN	# Information Disclosure - Debug Error Messages
          10024	WARN	# Information Disclosure - Sensitive Information in URL
          10025	WARN	# Information Disclosure - Sensitive Information in HTTP Referrer Header
          10026	WARN	# HTTP Parameter Override
          10027	WARN	# Information Disclosure - Suspicious Comments
          10028	WARN	# Open Redirect
          10029	WARN	# Cookie Poisoning
          10030	WARN	# User Controllable Charset
          10031	WARN	# User Controllable HTML Element Attribute
          10032	FAIL	# Viewstate Scanner
          10033	WARN	# Directory Browsing
          10034	WARN	# Heartbleed OpenSSL Vulnerability
          10035	FAIL	# Strict-Transport-Security Header Not Set
          10036	WARN	# Server Leaks Version Information via "Server" HTTP Response Header Field
          10037	WARN	# Server Leaks Information via "X-Powered-By" HTTP Response Header Field
          10038	FAIL	# Content Security Policy (CSP) Header Not Set
          10039	WARN	# X-Backend-Server Header Information Leak
          10040	FAIL	# Secure Pages Include Mixed Content
          10041	FAIL	# HTTP to HTTPS Insecure Transition in Form Post
          10042	WARN	# HTTPS to HTTP Insecure Transition in Form Post
          10043	WARN	# User Controllable JavaScript Event
          10044	WARN	# Big Redirect Detected
          10045	FAIL	# Source Code Disclosure
          10047	FAIL	# HTTPS Content Available via HTTP
          10048	WARN	# Remote Code Execution
          10049	WARN	# Storable and Cacheable Content
          10050	WARN	# Retrieved from Cache
          10051	WARN	# Relative Path Confusion
          10052	FAIL	# X-ChromeLogger-Data Header Information Leak
          10053	WARN	# Apache Range Header DoS
          10054	WARN	# Cookie Without SameSite Attribute
          10055	FAIL	# CSP Scanner
          10056	FAIL	# X-Debug-Token Scanner
          10057	FAIL	# Username Hash Found
          10058	FAIL	# GET for POST Scanner
          10059	WARN	# Http Parameter Pollution Scanner
          10060	WARN	# URL Redirector Abuse
          10061	FAIL	# X-AspNet-Version Response Header Scanner
          10062	WARN	# PII Scanner
          10063	WARN	# Feature Policy Scanner
          10094	WARN	# Base64 Disclosure
          10095	FAIL	# Backup File Disclosure
          10096	WARN	# Timestamp Disclosure
          10097	WARN	# Hash Disclosure
          10098	FAIL	# Cross-Domain Misconfiguration
          10099	WARN	# Source Code Disclosure
          10104	WARN	# User Agent Fuzzer
          10105	FAIL	# Authentication Credentials Captured
          10106	WARN	# HTTP Only Site
          10107	WARN	# Httpoxy - Proxy Header Misuse
          10108	WARN	# Reverse Tabnabbing
          10109	WARN	# Modern Web Application
          10110	FAIL	# Dangerous JS Functions Scanner
          10202	WARN	# Absence of Anti-CSRF Tokens
          2	WARN	# Private IP Disclosure
          3	WARN	# Session ID in URL Rewrite
          50001	FAIL	# Script Passive Scan Rules
          90001	FAIL	# Insecure JSF ViewState
          90003	WARN	# Sub Resource Integrity Attribute Missing
          90011	FAIL	# Charset Mismatch
          90022	FAIL	# Application Error Disclosure
          90030	WARN	# WSDL File Detection
          90033	WARN	# Loosely Scoped Cookie
          EOF
          
      - name: Upload ZAP HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report-${{ github.run_id }}
          path: zap-reports/
          retention-days: 30
          
      - name: Create issue if critical vulnerabilities found
        if: env.CRITICAL_VULNS_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Critical Security Vulnerabilities Found - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Critical/High Security Vulnerabilities Detected
            
            **Environment:** ${{ github.event.inputs.environment || 'staging' }}
            **Scan Date:** ${new Date().toISOString()}
            **Run ID:** ${{ github.run_id }}
            
            ### Summary
            - **Critical Vulnerabilities:** ${{ env.CRITICAL_COUNT }}
            - **High Vulnerabilities:** ${{ env.HIGH_COUNT }}
            - **Total High/Critical:** ${{ env.VULN_COUNT }}
            
            ### Action Required
            1. Review the [ZAP scan report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Download and analyze the full HTML report from artifacts
            3. Prioritize fixing Critical vulnerabilities immediately
            4. Address High vulnerabilities within 24 hours
            
            ### Escalation
            This issue requires immediate attention from the security team.
            
            cc: @security-team @devops-team`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'critical', 'staging', 'vulnerability']
            });
            
      - name: Fail job if critical/high vulnerabilities found
        if: env.CRITICAL_VULNS_FOUND == 'true'
        run: |
          echo "âŒ Critical or High severity vulnerabilities found!"
          echo "Total Critical/High vulnerabilities: ${{ env.VULN_COUNT }}"
          exit 1